let HOST_KEY=localStorage.getItem("HOST_KEY")||"";const qs=e=>document.querySelector(e),queueEl=qs("#queue"),historyEl=qs("#history"),countdown=qs("#countdown");let player=null,currentId=null,tickTimer=null;function headersAuth(){return HOST_KEY?{"Content-Type":"application/json","X-Host-Key":HOST_KEY}:{"Content-Type":"application/json"}}function who(e){return e.by_name?`${e.by_name} (${e.by_ip||""})`:e.by_ip||""}function rQueue(e){return`<div class="item">
    <img class="thumb" src="https://i.ytimg.com/vi/${e.id}/default.jpg">
    <div class="flex-1">
      <div>${e.title||e.id}</div>
      <div class="small">by ${who(e)}</div>
    </div>
    <button class="btn" data-id="${e.id}">Remove</button>
  </div>`}function rHistory(e){return`<div class="item">
    <img class="thumb" src="https://i.ytimg.com/vi/${e.id}/default.jpg">
    <div>
      <div class="text-sm">${e.title||e.id}</div>
      <div class="small">by ${who(e)}</div>
    </div>
  </div>`}window.onYouTubeIframeAPIReady=function(){player=new YT.Player("player",{videoId:"",playerVars:{autoplay:1,controls:1},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})};function onPlayerReady(){refresh(),tickTimer&&clearInterval(tickTimer),tickTimer=setInterval(sendProgressTick,1e3)}function onPlayerStateChange(e){e.data===YT.PlayerState.ENDED&&post("/api/progress",{ended:!0,videoId:currentId,pos:player.getDuration(),dur:player.getDuration()}).then((()=>setTimeout(refresh,800)))}async function post(e,t){const n=await fetch(e,{method:"POST",headers:headersAuth(),body:JSON.stringify(t||{})});return n.json().catch((()=>({}))) }async function refresh(){const e=await(await fetch('/api/state')).json();queueEl.innerHTML=(e.queue||[]).map(rQueue).join("")||'<div class="small">Queue empty</div>',historyEl.innerHTML=(e.history||[]).slice(0,15).map(rHistory).join("")||'<div class="small">No history</div>',qs("#rate").value=e.config&&e.config.rate_limit_s||180,qs("#nickHours").value=e.config&&e.config.nick_change_hours||24;const t=e.current&&e.current.id;t&&t!==currentId&&player&&(currentId=t,player.loadVideoById({videoId:t,startSeconds:0,suggestedQuality:'large'}))}async function sendProgressTick(){if(!player||!HOST_KEY)return;try{const e=Number(player.getDuration()||0),t=Number(player.getCurrentTime()||0),n=currentId;if(e>0){const n=Math.max(0,e-t);n<=3?(countdown.classList.remove('hidden'),countdown.textContent=Math.ceil(n)):countdown.classList.add('hidden')}await post('/api/progress',{videoId:n,pos:t,dur:e,ended:!1})}catch(e){}}qs("#saveKey").onclick=()=>{const e=qs("#key").value.trim();if(!e)return void alert("Enter HOST_API_KEY");HOST_KEY=e,localStorage.setItem("HOST_KEY",HOST_KEY),alert("Saved.")},qs("#btnPlay").onclick=async()=>{await post('/api/play',{}),await refresh()},qs("#btnNext").onclick=async()=>{await post('/api/next',{}),await refresh()},qs("#btnPrev").onclick=async()=>{await post('/api/prev',{}),await refresh()},qs("#btnClear").onclick=async()=>{await post('/api/clear',{}),await refresh()},qs("#btnReload").onclick=refresh,qs("#btnLogo").onclick=async()=>{const e=qs("#logo").files[0];if(!e)return void alert("Choose file");const t=new FormData;t.append("logo",e);const n=await fetch('/api/logo',{method:'POST',headers:HOST_KEY?{"X-Host-Key":HOST_KEY}:{},body:t});if(401===n.status)return void alert("Wrong HOST_API_KEY");alert("Logo uploaded"),setTimeout((()=>location.reload()),500)},qs("#btnSaveCfg").onclick=async()=>{const e=parseInt(qs("#rate").value||"180",10),t=parseInt(qs("#nickHours").value||"24",10),n=await fetch('/api/config',{method:'POST',headers:headersAuth(),body:JSON.stringify({rate_limit_s:e,nick_change_hours:t})});401===n.status?alert("Wrong HOST_API_KEY"):(alert("Saved."),refresh())},queueEl.addEventListener('click',async e=>{if("BUTTON"===e.target.tagName&&e.target.dataset.id){await post('/api/remove',{id:e.target.dataset.id}),refresh()}}),(window.YT&&window.YT.Player)&&window.onYouTubeIframeAPIReady(),refresh(),setInterval(refresh,2e3)