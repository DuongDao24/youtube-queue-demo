<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ app_title }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura-vader.css">
  <style>
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:10px;padding:16px;margin:10px 0}
    .muted{color:#888}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    .item{padding:8px 0;border-bottom:1px dashed #eee}
  </style>
</head>
<body>
  <h2>{{ app_title }}</h2>

  <div class="row">
    <div class="card">
      <h4>Add YouTube video</h4>
      <p class="muted">Limit: <b id="limit">{{settings.rate_limit_s}}</b>s / IP. Nick change every <b id="nickh">{{settings.nick_change_hours}}</b>h.</p>

      <div>
        <input id="nickname" placeholder="Your nickname (required)" style="width:60%" />
        <button id="btnSaveNick">Save nickname</button>
      </div>
      <div style="margin-top:8px">
        <input id="url" placeholder="https://www.youtube.com/watch?v=..." style="width:80%" />
        <button id="btnAdd">Add to queue</button>
      </div>
    </div>

    <div class="card">
      <h4>Now playing</h4>
      <div id="now">Loading...</div>
      <div style="margin-top:6px">
        <a id="open_yt" target="_blank">Open on YouTube</a>
      </div>
    </div>
  </div>

  <div class="card">
    <h4>Queue</h4>
    <div id="queue"></div>
  </div>

  <div class="card">
    <h4>History</h4>
    <div id="history"></div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const api = (u,method="GET",body=null)=>fetch(u,{
  method, headers:{'Content-Type':'application/json'},
  body: body?JSON.stringify(body):null
}).then(r=>r.json());

let me = {ip:"", nickname:""};

async function loadState(){
  try{
    const s = await api('/api/state');
    if(!s.ok) return;
    me = s.me;
    $('#limit').textContent = s.settings.rate_limit_s;
    $('#nickh').textContent = s.settings.nick_change_hours;
    if(me.nickname) $('#nickname').value = me.nickname;

    // now playing
    const c = s.current;
    if(c && c.url){
      $('#now').textContent = c.url;
      $('#open_yt').href = c.url;
    } else {
      $('#now').textContent = "(idle)";
      $('#open_yt').href = "#";
    }

    // queue
    const q = s.queue || [];
    $('#queue').innerHTML = q.map(x=>`<div class="item">${escapeHtml(x.url)} <span class="muted">â€” by ${escapeHtml(x.by_name||'Guest')}</span></div>`).join('') || '<div class="muted">Queue empty</div>';

    // history
    const h = s.history || [];
    $('#history').innerHTML = h.map(x=>`<div class="item">${escapeHtml(x.url)}</div>`).join('') || '<div class="muted">No history</div>';
  }catch(e){}
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

$('#btnSaveNick').onclick = async ()=>{
  const name = $('#nickname').value.trim();
  if(!name){ alert("Please enter nickname first."); return; }
  const r = await api('/api/nick','POST',{name});
  if(!r.ok){ alert(r.error||'Failed'); return; }
  loadState();
};

$('#btnAdd').onclick = async ()=>{
  const url = $('#url').value.trim();
  if(!$('#nickname').value.trim()){
    alert("Please set nickname first.");
    return;
  }
  const r = await api('/api/add','POST',{url});
  if(!r.ok){ alert(r.error||'Failed'); return; }
  $('#url').value='';
  loadState();
};

loadState();
setInterval(loadState, 2000);
</script>
</body>
</html>
