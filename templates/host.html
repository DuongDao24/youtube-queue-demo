<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ app_title }} — Host</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura-vader.css">
  <style>
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:10px;padding:16px;margin:10px 0}
    .row{display:grid;grid-template-columns:1.6fr .8fr;gap:16px}
    @media(max-width:1024px){.row{grid-template-columns:1fr}}
    .toolbar button{margin-right:8px}
    #loginMask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
    #loginBox{width:320px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 40px rgba(0,0,0,.25)}
    .muted{color:#888}
    iframe{width:100%;height:55vh;border:0;border-radius:8px;background:#000}
  </style>
</head>
<body>
  <h2>{{ app_title }} — Host</h2>

  <div class="card toolbar">
    <button id="btnPrev">Prev</button>
    <button id="btnPause">Pause / Resume</button>
    <button id="btnNext">Next</button>
    <button id="btnClear">Clear</button>
  </div>

  <div class="row">
    <div class="card">
      <h4>Now Playing</h4>
      <iframe id="player" allow="autoplay"></iframe>
    </div>

    <div>
      <div class="card">
        <h4>Queue</h4>
        <div id="queue"></div>
      </div>
      <div class="card">
        <h4>Recent history</h4>
        <div id="history"></div>
      </div>
      <div class="card">
        <h4>Settings</h4>
        <div>Submit limit (seconds): <input id="limit" style="width:100px" /> </div>
        <div style="margin-top:6px">Nickname change (hours):
          <select id="nickh">
            <option>1</option><option>2</option><option>4</option>
            <option>8</option><option>12</option><option selected>24</option>
            <option>48</option><option>72</option>
          </select>
        </div>
        <button id="btnSaveSet" style="margin-top:8px">Save settings</button>

        <hr/>
        <h5>Host Auth</h5>
        <div><input id="newUser" placeholder="New username" style="width:100%"></div>
        <div style="margin-top:6px"><input id="newPass" placeholder="New password" style="width:100%"></div>
        <div style="margin-top:6px"><input id="key" placeholder="HOST_API_KEY to confirm" style="width:100%"></div>
        <button id="btnChange" style="margin-top:6px">Save host auth</button>
        <div class="muted">* Đổi tài khoản cần HOST_API_KEY.</div>
      </div>
    </div>
  </div>

  <!-- ONE modal only -->
  <div id="loginMask">
    <div id="loginBox">
      <h4 style="margin-top:0">Host Login</h4>
      <div><input id="user" placeholder="Username" value="Admin" style="width:100%"></div>
      <div style="margin-top:6px"><input id="pass" placeholder="Password" type="password" value="0000" style="width:100%"></div>
      <div id="msg" class="muted" style="color:#c00;margin-top:6px"></div>
      <div style="margin-top:10px;text-align:right">
        <button id="btnDoLogin">Login</button>
      </div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const api = (u,m="GET",b=null)=>fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):null}).then(r=>r.json());
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

let state = {current:null, queue:[], history:[], settings:{}};
let logged = {{ "true" if is_host else "false" }};

function showLoginMask(on){ $('#loginMask').style.display = on?'flex':'none'; }

async function ensureLogin(){
  if(!logged){ showLoginMask(true); }
}
async function doLogin(){
  const user = $('#user').value.trim();
  const pass = $('#pass').value.trim();
  const r = await api('/api/host/login','POST',{user,pass});
  if(!r.ok){ $('#msg').textContent = r.error || 'Login failed'; return; }
  logged = true; $('#msg').textContent='';
  showLoginMask(false);
  loadState();
}
$('#btnDoLogin').onclick = doLogin;
document.addEventListener('keydown', (e)=>{ if($('#loginMask').style.display==='flex' && e.key==='Enter'){ doLogin(); } });

async function loadState(){
  const s = await api('/api/state');
  if(!s.ok) return;
  state = s;

  // player
  const cur = s.current;
  const iframe = $('#player');
  if(cur && cur.url){
    // dùng embed
    const id = extractYT(cur.url);
    iframe.src = id ? `https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1` : '';
  } else {
    iframe.src = '';
  }

  // queue
  $('#queue').innerHTML = (s.queue||[]).map(x=>`<div class="muted">• ${escapeHtml(x.url)} — by ${escapeHtml(x.by_name||'Guest')}</div>`).join('') || '<div class="muted">Queue empty</div>';
  // history
  $('#history').innerHTML = (s.history||[]).map(x=>`<div class="muted">• ${escapeHtml(x.url)}</div>`).join('') || '<div class="muted">No history</div>';

  // settings
  $('#limit').value = s.settings.rate_limit_s;
  $('#nickh').value = s.settings.nick_change_hours;
}

function extractYT(u){
  // rất gọn cho watch?v= và youtu.be
  const m1 = u.match(/[?&]v=([^&]+)/);
  if(m1) return m1[1];
  const m2 = u.match(/youtu\.be\/([^?]+)/);
  if(m2) return m2[1];
  return '';
}

$('#btnPrev').onclick = async ()=>{ const r = await api('/api/host/prev','POST',{}); if(!r.ok){alert(r.error||'Failed');} loadState(); }
$('#btnNext').onclick = async ()=>{ const r = await api('/api/host/next','POST',{}); if(!r.ok){alert(r.error||'Failed');} loadState(); }
$('#btnClear').onclick = async ()=>{ const r = await api('/api/host/clear','POST',{}); if(!r.ok){alert(r.error||'Failed');} loadState(); }

let paused=false;
$('#btnPause').onclick = ()=>{ 
  // chỉ toggle nút & player YouTube sẽ tự xử lý (ở bản tối giản)
  paused = !paused;
  $('#btnPause').textContent = paused? 'Resume':'Pause / Resume';
};

$('#btnSaveSet').onclick = async ()=>{
  const rs = parseInt($('#limit').value||'0',10);
  const nh = parseInt($('#nickh').value||'0',10);
  const r = await api('/api/host/save_settings','POST',{rate_limit_s:rs,nick_change_hours:nh});
  if(!r.ok){alert(r.error||'Failed');return;}
  loadState();
};

$('#btnChange').onclick = async ()=>{
  const user = $('#newUser').value.trim();
  const pass = $('#newPass').value.trim();
  const key  = $('#key').value.trim();
  if(!key){alert('Need HOST_API_KEY');return;}
  const r = await api('/api/host/change_auth','POST',{user,pass,key});
  if(!r.ok){alert(r.error||'Failed');return;}
  alert('Host auth updated.');
};

ensureLogin();
loadState();
setInterval(loadState,2000);
</script>
</body>
</html>
